name: Daily Price & Strategy
on:
  schedule:
    - cron: '30 7 * * 1-5' # å°åŒ— 15:30
  workflow_dispatch:

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install dependencies
        run: |
          pip install pandas yfinance lxml python-dotenv numpy pyarrow requests beautifulsoup4

      - name: Prepare Data Directories (Safe Clean)
        run: |
          echo "ğŸ§¹ æ­£åœ¨æ•´ç†è³‡æ–™å¤¾çµæ§‹..."
          # ğŸŸ¢ å„ªåŒ–ï¼šå»ºç«‹æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„ç›®éŒ„ï¼Œé˜²æ­¢ Python æ‰¾ä¸åˆ°è·¯å¾‘
          mkdir -p data/cache/tw
          mkdir -p data/indicators
          mkdir -p data/temp
          mkdir -p data/meta 
          
          # åªåˆªé™¤å…§å®¹ï¼Œä¿ç•™ç›®éŒ„çµæ§‹
          rm -f data/cache/tw/* || echo "Cache already empty"
          rm -f data/indicators/* || echo "Indicators already empty"

      - name: Generate Stock List (Missing File Protection)
        run: |
          echo "ğŸ“‹ æª¢æŸ¥ä¸¦ç”¢ç”Ÿè‚¡ç¥¨æ¸…å–®..."
          # ğŸŸ¢ å†æ¬¡ç¢ºä¿ç›®éŒ„å­˜åœ¨ (é›™é‡ä¿éšª)
          mkdir -p data
          python scripts/update_stock_list.py

      - name: Fetch Price & Run Strategy
        run: |
          # åŸ·è¡Œ K ç·šä¸‹è¼‰èˆ‡ç­–ç•¥è¨ˆç®—
          # ğŸŸ¢ å†æ¬¡ç¢ºä¿ cache ç›®éŒ„å­˜åœ¨
          mkdir -p data/cache/tw
          python scripts/init_cache_tw.py --auto --force
          python scripts/daily_strategy_runner.py

      - name: Commit and Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f "data/stock_list.csv" ]; then git add -f data/stock_list.csv; fi
          if [ -d "data/indicators" ]; then git add -f data/indicators/; fi
          if [ -d "data/cache/tw" ]; then git add -f data/cache/tw/; fi
          
          git commit -m "Auto: Price & Strategy Update ($(date +'%Y-%m-%d'))" || echo "No changes to commit"
          
          # ğŸŸ¢ åŒæ¨£åŠ å…¥å¼·åˆ¶æ¸…ç†ï¼Œé˜²æ­¢è¡çª
          git reset --hard HEAD
          
          git pull --rebase -X theirs origin main
          git push origin main