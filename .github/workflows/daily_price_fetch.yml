name: Daily Price & Strategy
on:
  schedule:
    # æ–¹æ¡ˆäºŒï¼šä¸€æ—¥å…©æ›´
    # UTC 07:30 = å°åŒ— 15:30 (å…ˆçœ‹ Kç·šèˆ‡æ³•äººåœŸæ´‹å°ä½œ)
    # UTC 14:30 = å°åŒ— 22:30 (è£œé½Šèè³‡èåˆ¸ï¼Œå–å¾—å®Œæ•´å…¨è²Œ)
    - cron: '30 7,14 * * 1-5'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install dependencies
        run: |
          pip install pandas yfinance lxml python-dotenv numpy pyarrow requests beautifulsoup4

      - name: Prepare & Run Strategy
        run: |
          # å»ºç«‹å¿…è¦çš„è³‡æ–™å¤¾çµæ§‹
          mkdir -p data/cache/tw
          mkdir -p data/indicators
          mkdir -p data/temp
          mkdir -p data/strategy_results
          
          # å®Œæ•´çš„å·¥ä½œæµç®¡ç·š (Pipeline) ä¸‰éƒ¨æ›²
          echo "1. åŸ·è¡Œä¸‹è¼‰èˆ‡é‹ç®— K ç·š..."
          python scripts/init_cache_tw.py --auto --force
          
          echo "2. æŠ“å–ç±Œç¢¼ã€ç‡Ÿæ”¶èˆ‡è²¡å ±åº•ç¨¿ (è§£æ±ºä½ éå¹´é‡åˆ°çš„ç©ºè³‡æ–™å•é¡Œ)..."
          python scripts/update_chips_revenue.py
          
          echo "3. åŸ·è¡Œç­–ç•¥é‹ç®—ç”¢å‡ºå¿«ç…§..."
          python scripts/calc_snapshot_factors.py

      - name: Zip Results (The Smart Way)
        run: |
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…é‹ç®—çµæœ..."
          # 1. ç”¢ç”Ÿç‹€æ…‹æª” (çµ¦ App æª¢æŸ¥ç”¨)
          echo "{\"update_time\": \"$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M')\", \"source\": \"github_actions\"}" > data/data_status.json
          
          # 2. å£“ç¸® (åŠ å…¥ temp åº•ç¨¿èˆ‡ strategy_results å¿«ç…§)
          cd data
          zip -r daily_data.zip cache/tw indicators temp strategy_results stock_list.csv data_status.json
          
          echo "æ‰“åŒ…å®Œæˆ: data/daily_data.zip"

      - name: Commit Zip Only
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ¸…é™¤æ•£äº‚çš„å¿«å–æª”æ¡ˆè¿½è¹¤
          git rm -r --cached data/cache/tw || true
          git rm -r --cached data/indicators || true
          git rm -r --cached data/temp || true
          git rm -r --cached data/strategy_results || true
          
          # åªåŠ å…¥ ZIP å’Œ JSON
          git add -f data/daily_data.zip
          git add -f data/data_status.json
          
          git commit -m "Auto: Cloud Strategy Update ($(date +'%Y-%m-%d %H:%M'))" || echo "No changes"
          
          git pull --rebase -X theirs origin main
          git push origin main