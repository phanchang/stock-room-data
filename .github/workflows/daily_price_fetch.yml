name: Daily Price & Strategy
on:
  schedule:
    - cron: '0 7 * * 1-5' # å°åŒ— 15:00
  workflow_dispatch:

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }
      - name: Install dependencies
        run: pip install pandas yfinance lxml python-dotenv numpy pyarrow
      - name: Fetch Price & Run Strategy
        run: |
          python scripts/init_cache_tw.py --auto
          python scripts/daily_strategy_runner.py
      - name: Commit and Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/indicators/
          git commit -m "Auto: Update Daily Strategy Indicators" || echo "No changes to commit"
          git pull --rebase origin main  # ğŸŸ¢ åŠ å…¥é€™è¡Œï¼šå…ˆæ‹‰å›é ç«¯æ›´æ–°ï¼Œé¿å…è¡çª
          git push origin main
      - name: Commit and Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
                
          # 1. æŠŠæ‰€æœ‰ä½ è¦ä¿ç•™çš„è³‡æ–™å¤¾éƒ½ add é€²ä¾†
          git add data/indicators/
          git add data/goodinfo/ || echo "No goodinfo changes"
             
          # 2. æäº¤è®Šæ›´
          git commit -m "Auto: Update Daily Strategy Indicators" || echo "No changes to commit"
             
          # 3. ğŸŸ¢ é—œéµï¼šæ‹‹æ£„æ‰€æœ‰å‰©ä¸‹çš„ã€æœªè¢« add çš„è®Šæ›´ (ä¾‹å¦‚ cache çš„æ›´å‹•)
          # é€™æ¨£ git pull --rebase å°±ä¸æœƒå ±éŒ¯
          git checkout .
          git clean -fd
                
                # 4. æ‹‰å–ä¸¦æ¨é€
                git pull --rebase origin main
                git push origin main