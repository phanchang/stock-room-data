name: Daily Price & Strategy
on:
  schedule:
    - cron: '30 7 * * 1-5' # å°åŒ— 15:30
  workflow_dispatch:

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install dependencies
        run: |
          pip install pandas yfinance lxml python-dotenv numpy pyarrow requests beautifulsoup4

      - name: Prepare Data Directories (Safe Clean)
        run: |
          echo "ğŸ§¹ æ­£åœ¨æ•´ç†è³‡æ–™å¤¾çµæ§‹..."
          # ğŸŸ¢ å„ªåŒ–ï¼šç¢ºä¿ç›®éŒ„å­˜åœ¨ï¼Œä¸”åªæ¸…ç†ç‰¹å®šçš„å¿«å–èˆ‡æŒ‡æ¨™ï¼Œä¸åˆªé™¤æ•´å€‹ data ç›®éŒ„
          mkdir -p data/cache/tw
          mkdir -p data/indicators
          mkdir -p data/temp
          
          # åªåˆªé™¤å…§å®¹ï¼Œä¿ç•™ç›®éŒ„çµæ§‹
          rm -f data/cache/tw/* || echo "Cache already empty"
          rm -f data/indicators/* || echo "Indicators already empty"

      - name: Generate Stock List (Missing File Protection)
        run: |
          echo "ğŸ“‹ æª¢æŸ¥ä¸¦ç”¢ç”Ÿè‚¡ç¥¨æ¸…å–®..."
          # ğŸŸ¢ é—œéµï¼šå…ˆè·‘é€™æ”¯ç¢ºä¿ data/stock_list.csv ä¸€å®šå­˜åœ¨
          python scripts/update_stock_list.py

      - name: Fetch Price & Run Strategy
        run: |
          # åŸ·è¡Œ K ç·šä¸‹è¼‰èˆ‡ç­–ç•¥è¨ˆç®—
          python scripts/init_cache_tw.py --auto --force
          python scripts/daily_strategy_runner.py

      - name: Commit and Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ğŸŸ¢ ä½¿ç”¨ -f å¼·åˆ¶åŠ å…¥ï¼Œä¸¦åŠ ä¸Š existence check é¿å…å ±éŒ¯
          if [ -f "data/stock_list.csv" ]; then git add -f data/stock_list.csv; fi
          if [ -d "data/indicators" ]; then git add -f data/indicators/; fi
          if [ -d "data/cache/tw" ]; then git add -f data/cache/tw/; fi
          
          git commit -m "Auto: Price & Strategy Update ($(date +'%Y-%m-%d'))" || echo "No changes to commit"
          
          # ğŸŸ¢ ä¸€å‹æ°¸é€¸çš„è¡çªè§£æ±ºç­–ç•¥
          git pull --rebase -X theirs origin main
          git push origin main