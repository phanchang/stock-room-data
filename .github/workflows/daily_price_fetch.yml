name: Daily Price & Strategy
on:
  schedule:
    - cron: '30 7 * * 1-5' # å°åŒ— 15:30
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install dependencies
        run: |
          pip install pandas yfinance lxml python-dotenv numpy pyarrow requests beautifulsoup4

      - name: Prepare & Run Strategy
        run: |
          mkdir -p data/cache/tw
          mkdir -p data/indicators
          # åŸ·è¡Œä¸‹è¼‰èˆ‡é‹ç®—
          python scripts/init_cache_tw.py --auto --force
          python scripts/daily_strategy_runner.py

      - name: Zip Results (The Smart Way)
        run: |
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…é‹ç®—çµæœ..."
          # 1. ç”¢ç”Ÿç‹€æ…‹æª” (çµ¦ App æª¢æŸ¥ç”¨)
          echo "{\"update_time\": \"$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M')\", \"source\": \"github_actions\"}" > data/data_status.json
          
          # 2. å£“ç¸® (åªæ‰“åŒ… cache å’Œ indicatorsï¼Œæ’é™¤ git æª”)
          # -r: éè¿´, -j: ä¸ä¿ç•™æœ€å¤–å±¤ç›®éŒ„çµæ§‹(è¦–éœ€æ±‚), é€™è£¡å»ºè­°ä¿ç•™ data/cache çµæ§‹æ–¹ä¾¿è§£å£“
          # æ³¨æ„ï¼šæˆ‘å€‘å…ˆé€²åˆ° data ç›®éŒ„å†å£“ç¸®ï¼Œé€™æ¨£è§£å£“æ™‚è·¯å¾‘æ¯”è¼ƒä¹¾æ·¨
          cd data
          zip -r daily_data.zip cache/tw indicators stock_list.csv data_status.json
          
          # 3. ç§»å‹• zip åˆ°æ ¹ç›®éŒ„æº–å‚™ commit (æˆ–è€…ç•™åœ¨ data è£¡ä¹Ÿå¯ä»¥ï¼Œé€™é‚Šé è¨­æ”¾åœ¨ data/)
          echo "æ‰“åŒ…å®Œæˆ: data/daily_data.zip"

      - name: Commit Zip Only
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # âš ï¸ é—œéµï¼šå…ˆç§»é™¤èˆŠçš„æ•£äº‚æª”æ¡ˆ (å¦‚æœä¹‹å‰æœ‰ commit éçš„è©±)
          # é€™é‚Šç”¨ git rm -r --cached è®“ git ä¸å†è¿½è¹¤é‚£äº›è³‡æ–™å¤¾ï¼Œä½†å¯¦é«”æª”æ¡ˆé‚„åœ¨
          git rm -r --cached data/cache/tw || true
          git rm -r --cached data/indicators || true
          
          # åªåŠ å…¥ ZIP å’Œ JSON
          git add -f data/daily_data.zip
          git add -f data/data_status.json
          
          git commit -m "Auto: Cloud Strategy Update ($(date +'%Y-%m-%d'))" || echo "No changes"
          
          git pull --rebase -X theirs origin main
          git push origin main