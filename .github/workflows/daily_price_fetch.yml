name: Daily Price & Strategy
on:
  schedule:
    - cron: '30 7 * * 1-5' # ğŸŸ¢ æ”¹ç‚ºå°åŒ— 15:30 (UTC 07:30) ç¢ºä¿ç›¤å¾Œè³‡æ–™å®Œæ•´
  workflow_dispatch:

jobs:
  run-daily:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install dependencies
        run: pip install pandas yfinance lxml python-dotenv numpy pyarrow

      - name: Clean up Old Data (Force Refresh)
        run: |
          echo "ğŸ§¹ é–‹å§‹æ¸…ç†èˆŠè³‡æ–™..."
          # ğŸŸ¢ å¼·åˆ¶åˆªé™¤æ‰€æœ‰ K ç·šå¿«å–èˆ‡æŒ‡æ¨™ï¼Œç¢ºä¿ç æ‰é‡ç·´
          rm -rf data/cache/tw/*
          rm -rf data/indicators/*
          echo "âœ… æ¸…ç†å®Œæˆï¼Œæº–å‚™é‡æ–°ä¸‹è¼‰ã€‚"

      - name: Fetch Price & Run Strategy
        run: |
          # ğŸŸ¢ åŠ å…¥ --force åƒæ•¸ï¼Œå¼·åˆ¶é‡æ–°ä¸‹è¼‰å…¨æ­·å²
          python scripts/init_cache_tw.py --auto --force
          
          # é‡æ–°è¨ˆç®—æŒ‡æ¨™ (æ­¤æ™‚æŒ‡æ¨™è³‡æ–™å¤¾æ˜¯ç©ºçš„ï¼Œæœƒç”Ÿæˆå…¨æ–°çš„)
          python scripts/daily_strategy_runner.py

      - name: Commit and Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. å¼·åˆ¶åŠ å…¥æ–°ç”Ÿæˆçš„è³‡æ–™
          git add -f data/indicators/
          git add -f data/cache/tw/
          git add -f data/stock_list.csv
          
          # 2. æäº¤
          git commit -m "Auto: Force Refresh Price & Strategy" || { echo "No changes to commit"; exit 0; }
          
          # 3. æ¸…ç†æˆ°å ´
          git reset --hard
          
          # 4. èåˆé›²ç«¯è³‡æ–™
          git pull --rebase origin main
          
          # 5. æ¨é€
          git push origin main